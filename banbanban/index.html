<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>BAN BAN BAN</title>
  <style>
  /* ===== Arcade Link Style ===== */
a {
  color: #7CFF6B;                 /* äº®ç¶ ä¸»è‰² */
  text-decoration: none;
  font-weight: 700;
  position: relative;
  transition: color .15s ease, text-shadow .15s ease;
}

a::after {
  content: "";
  position: absolute;
  left: 0; bottom: -2px;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg, #7CFF6B, #19C37D);
  opacity: .7;
}

a:hover {
  color: #EFFFF6;
  text-shadow: 0 0 6px rgba(124,255,107,.7);
}

a:hover::after {
  opacity: 1;
  box-shadow: 0 0 6px rgba(124,255,107,.7);
}

a:active {
  color: #19C37D;
  text-shadow: 0 0 10px rgba(124,255,107,1);
}

/* é»éçš„é€£çµ */
a:visited {
  color: #4BEF88;
}
    :root{
      --bg:#0b0c10;
      --panel:#111319;
      --line:#2a2f3a;
      --txt:#d7dbe6;
      --muted:#9aa3b2;
      --danger:#ff3b3b;
      --warn:#ffcc33;
      --ok:#44a7ff;
      --good:#7CFF6B;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--txt);
      font-family:system-ui,-apple-system,"Segoe UI","Noto Sans TC",sans-serif;}
    .wrap{min-height:100%; display:flex; align-items:center; justify-content:center; padding:16px;}
    .app{width:min(960px, 96vw); display:grid; gap:12px;}
    .top{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      background:linear-gradient(180deg, rgba(255,59,59,0.14), rgba(255,59,59,0.05));
      border:1px solid var(--line); border-radius:14px; padding:12px 14px;
      box-shadow:0 8px 30px rgba(0,0,0,.35);
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .badge{
      width:34px; height:34px; border-radius:10px; display:grid; place-items:center;
      background:rgba(255,59,59,.18); border:1px solid rgba(255,59,59,.35);
      font-weight:900; letter-spacing:.5px;
    }
    .title{line-height:1.1}
    .title b{font-size:16px}
    .title div{font-size:12px; color:var(--muted); margin-top:2px}
    .stats{display:flex; gap:14px; flex-wrap:wrap; align-items:center;}
    .stat{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px; padding:8px 10px; min-width:120px;
    }
    .stat .k{font-size:12px; color:var(--muted)}
    .stat .v{font-size:18px; font-weight:800; margin-top:2px}
    .bar{height:10px; border-radius:999px; background:rgba(255,255,255,.06); overflow:hidden; margin-top:6px}
    .bar > i{display:block; height:100%; width:0%; background:var(--danger)}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    button{
      appearance:none; border:none; cursor:pointer;
      background:rgba(255,59,59,.18); color:var(--txt);
      border:1px solid rgba(255,59,59,.45); border-radius:12px;
      padding:10px 12px; font-weight:800;
      box-shadow:0 8px 22px rgba(0,0,0,.28);
    }
    button:hover{filter:brightness(1.08)}
    button:active{transform:translateY(1px)}
    .ghost{
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.10);
      color:var(--txt); font-weight:700;
    }
    .hint{
      font-size:12px; color:var(--muted); line-height:1.4;
      padding:0 2px;
    }
    canvas{
      width:100%; height:auto;
      background:
        radial-gradient(600px 260px at 70% 20%, rgba(68,167,255,.08), transparent 60%),
        radial-gradient(560px 240px at 20% 80%, rgba(255,59,59,.10), transparent 60%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.02) 0px, rgba(255,255,255,.02) 1px, transparent 1px, transparent 28px),
        repeating-linear-gradient(90deg, rgba(255,255,255,.02) 0px, rgba(255,255,255,.02) 1px, transparent 1px, transparent 28px);
      border:1px solid var(--line); border-radius:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      touch-action:manipulation;
	  cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><text x='8' y='22' font-size='20' fill='white' stroke='black' stroke-width='1'>âœ˜</text></svg>") 16 16, auto;
    }
    .toast{
      position:fixed; left:50%; top:14px; transform:translateX(-50%);
      background:rgba(15,17,23,.92); border:1px solid rgba(255,255,255,.10);
      padding:10px 12px; border-radius:12px; font-size:13px; color:var(--txt);
      box-shadow:0 12px 40px rgba(0,0,0,.4);
      opacity:0; pointer-events:none; transition:opacity .2s;
      max-width:min(640px, 92vw);
      display:flex; gap:8px; align-items:flex-start;
    }
    .toast.show{opacity:1}
    .toast .dot{width:10px; height:10px; border-radius:999px; background:var(--warn); margin-top:4px}
    .footer{display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px}
    .kbd{
      display:inline-block; padding:2px 6px; border-radius:8px;
      background:#1a1e27; border:1px solid rgba(255,255,255,.10); color:var(--txt);
      font-size:12px; font-weight:700;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="app">
    <div class="top">
      <div class="brand">
        <div class="badge">BAN</div>
        <div class="title">
          <b>BAN BAN BAN</b>
          <div>è³‡å®‰æª¢æ¸¬æŒ‡æ¨™å…¨æ•¸ä¸åˆæ ¼ï¼æ”¿åºœå»å‡½è¦æ±‚å…¨éƒ½ä¸é…åˆï¼è¬æƒ¡çš„å°ç´…æ›¸å¿…é ˆè¢« BANï¼</div>
        </div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="k">åˆ†æ•¸</div>
          <div class="v" id="score">0</div>
        </div>
        <div class="stat">
          <div class="k">é€£æ“Š</div>
          <div class="v" id="combo">0</div>
        </div>
        <div class="stat" style="min-width:220px">
          <div class="k">æ±¡æŸ“å€¼ <span id="polPct">0%</span></div>
          <div class="bar"><i id="polBar"></i></div>
        </div>
      </div>

      <div class="controls">
        <button id="btnStart">é–‹å§‹</button>
        <button class="ghost" id="btnRestart">é‡ä¾† (R)</button>
        <button class="ghost" id="btnMute">éŸ³æ•ˆï¼šé–‹</button>
      </div>
    </div>

    <canvas id="c" width="960" height="540"></canvas>

    <div class="footer">
      <div class="hint">
        æ“ä½œï¼šæ»‘é¼ /æ‰‹æŒ‡é»æ“Šæ³¡æ³¡å°é–ï¼›<span class="kbd">R</span> é‡é–‹ï¼›é€£æ“Š 12 é€² BAN MODEï¼ˆå¾—åˆ†åŠ å€ + é¡å¤–å›è¡€ï¼‰ã€‚<br/>
        å½©è›‹ï¼šå¥ˆç±³é¦™è•‰æœƒåˆ†è£‚ã€åœ‹æ—…ç›¤å­æœƒæ‰£åˆ†+å¢æ±™ã€å›ç­”æˆ‘æœƒå¡ä½ ä¸€ä¸‹ã€æ™®ç™¼ä¸€è¬è¶…ç¨€æœ‰æ¸…å ´å›è¡€ã€‚
      </div>
      <div class="hint">
        æ­¡è¿è‡³ YouTube æ”¶è½<a href="https://youtu.be/tmONZecue6c" target="_blank">ä¸»é¡Œæ›²ã€BAN BAN BANã€</a>ï¼ by <a href="https://blog.elielin.com/" target="_blank">elielin</a> with <a href="https://chatgpt.com/" target="_blank">ChatGTP</a>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"><div class="dot"></div><div id="toastText"></div></div>

<script>
(() => {

const BGM = new Audio("bgm.mp3");
BGM.loop = true;
BGM.volume = 0.35;   // å¯è‡ªè¡Œèª¿å°è²ä¸€é»

  // =============================
  // ä½ è¦æ›åœ–ï¼šåªæ”¹é€™ä¸€æ®µæª”åå³å¯
  // æŠŠåœ–ç‰‡è·Ÿ HTML æ”¾åŒä¸€è³‡æ–™å¤¾ï¼ˆæˆ– GitHub Pages åŒä¸€è·¯å¾‘ï¼‰
  // =============================
  const SPRITE_FILES = {
    normal: "xhs.png",
    nano: "nano.png",
    plate: "plate.png",
    answer: "answer.png",
    cash: "cash.png",
  };

  // ===== Canvas / UI =====
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  const scoreEl = document.getElementById("score");
  const comboEl = document.getElementById("combo");
  const polPctEl = document.getElementById("polPct");
  const polBarEl = document.getElementById("polBar");
  const btnStart = document.getElementById("btnStart");
  const btnRestart = document.getElementById("btnRestart");
  const btnMute = document.getElementById("btnMute");
  const toast = document.getElementById("toast");
  const toastText = document.getElementById("toastText");

  const W = 960, H = 540;
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

  function setCanvasScale(){
    const cssW = canvas.clientWidth || W;
    const ratio = cssW / W;
    const realW = Math.round(W * DPR);
    const realH = Math.round(H * DPR);
    if (canvas.width !== realW || canvas.height !== realH){
      canvas.width = realW;
      canvas.height = realH;
    }
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  setCanvasScale();
  window.addEventListener("resize", setCanvasScale);

  // ===== Image loading (auto fallback to text if missing) =====
  function loadImg(src){
    const img = new Image();
    img.src = src;
    return img;
  }
  const sprite = {
    normal: loadImg(SPRITE_FILES.normal),
    nano: loadImg(SPRITE_FILES.nano),
    plate: loadImg(SPRITE_FILES.plate),
    answer: loadImg(SPRITE_FILES.answer),
    cash: loadImg(SPRITE_FILES.cash),
  };
  function imgReady(img){
    return img && img.complete && img.naturalWidth > 0;
  }

  // ===== Helpers =====
  const rand = (a,b) => Math.random()*(b-a)+a;
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const dist2 = (x1,y1,x2,y2) => {
    const dx = x1-x2, dy = y1-y2;
    return dx*dx + dy*dy;
  };

  function toastMsg(msg, dotColor){
    toastText.textContent = msg;
    toast.querySelector(".dot").style.background = dotColor || "var(--warn)";
    toast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toast.classList.remove("show"), 1600);
  }

  // ===== Audio (WebAudio beep) =====
  let muted = false;
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let ac = null;

  function beep(freq=440, dur=0.05, type="square", gain=0.05){
    if(muted) return;
    try{
      if(!ac) ac = new AudioCtx();
      const o = ac.createOscillator();
      const g = ac.createGain();
      o.type = type;
      o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g); g.connect(ac.destination);
      o.start();
      o.stop(ac.currentTime + dur);
    }catch(e){}
  }

  // ===== Bubble Types =====
  const TYPES = {
    NORMAL: "normal",
    NANO_BANANA: "nano",
    TRAVEL_PLATE: "plate",
    ANSWER_ME: "answer",
    CASH_10K: "cash",
  };

  // ===== Game State =====
  const bubbles = [];
  const particles = [];

  let running = false;
  let over = false;
  let lastT = 0;

  let score = 0;
  let combo = 0;
  let comboTimer = 0;

  let pol = 0; // 0..100
  let spawnRate = 1.2;
  let timeAlive = 0;

  let banMode = false;
  let banModeTimer = 0;

  let stunTimer = 0; // "å›ç­”æˆ‘"å¹²æ“¾
  let spawnAcc = 0;

  function pickType(){
    const r = Math.random();
    if(r < 0.02) return TYPES.ANSWER_ME;
    if(r < 0.04) return TYPES.TRAVEL_PLATE;
    if(r < 0.07) return TYPES.NANO_BANANA;
    if(r < 0.08) return TYPES.CASH_10K;
    return TYPES.NORMAL;
  }

  function makeBubble(x=null, y=null, type=null, scale=1){
    const t = type || pickType();
    const rBase = (t===TYPES.CASH_10K) ? rand(22,30) : rand(20,32);
    const r = rBase * scale;

    const bx = (x==null) ? rand(r, W - r) : x;
    const by = (y==null) ? rand(r, H - r) : y;

    const speed = rand(18, 70) * (t===TYPES.NANO_BANANA ? 1.15 : 1.0);
    const ang = rand(0, Math.PI*2);
    const vx = Math.cos(ang)*speed;
    const vy = Math.sin(ang)*speed;

    // ===== ä½ ç›®å‰èª¿æˆã€Œå¤§æ¦‚ 60 ç§’ç¬¬ä¸€æ¬¡æ­»ã€çš„ç¯€å¥ =====
    const life = rand(3.2, 5.4) * (t===TYPES.ANSWER_ME ? 1.15 : 1.0);

    return {
      x: bx, y: by, r,
      vx, vy,
      type: t,
      age: 0,
      life,
      wob: rand(0.6, 1.6),
    };
  }

  function roundRect(ctx,x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y, x+w,y+h, rr);
    ctx.arcTo(x+w,y+h, x,y+h, rr);
    ctx.arcTo(x,y+h, x,y, rr);
    ctx.arcTo(x,y, x+w,y, rr);
    ctx.closePath();
  }

  // ===== Particles =====
  function spawnTextBurst(x,y,text, n=10){
    for(let i=0;i<n;i++){
      particles.push({
        x,y,
        vx: rand(-120,120),
        vy: rand(-160,-40),
        g: 380,
        life: rand(0.4, 0.9),
        age: 0,
        text,
        size: rand(12,16),
        rot: rand(-0.6,0.6),
      });
    }
  }

  // ===== Input =====
  function getCanvasPoint(evt){
    const rect = canvas.getBoundingClientRect();
    const cx = (evt.clientX - rect.left) * (W / rect.width);
    const cy = (evt.clientY - rect.top) * (H / rect.height);
    return {x: cx, y: cy};
  }

  function startGame(forceResumeAudio=false){
    if(forceResumeAudio && ac && ac.state === "suspended"){
      ac.resume().catch(()=>{});
    }
    if(!running){
      running = true;
      over = false;
      btnStart.textContent = "é€²è¡Œä¸­";
      toastMsg("é–‹å§‹ï¼BAN BAN BANï¼", "var(--danger)");
      beep(520,0.06,"square",0.06);
    }
  }

  function restart(){
    bubbles.length = 0;
    particles.length = 0;
    running = true;
    over = false;
    lastT = 0;

    score = 0;
    combo = 0;
    comboTimer = 0;
    pol = 0;

    spawnRate = 1.2;
    timeAlive = 0;

    banMode = false;
    banModeTimer = 0;

    stunTimer = 0;
    spawnAcc = 0;

    for(let i=0;i<6;i++) bubbles.push(makeBubble());
    btnStart.textContent = "é€²è¡Œä¸­";
    toastMsg("é‡æ–°é–‹å§‹ï¼", "var(--ok)");
    beep(620,0.06,"square",0.06);
    syncUI();
	
	BGM.play().catch(()=>{});
  }

  function gameOver(){
    over = true;
    running = false;
    btnStart.textContent = "é–‹å§‹";
    toastMsg("æ±¡æŸ“å€¼çˆ†è¡¨ï¼BAN å¤±æ•—ï¼ˆæŒ‰ R é‡ä¾†ï¼‰", "var(--danger)");
    beep(90,0.18,"sawtooth",0.06);
	BGM.pause();
	BGM.currentTime = 0;
  }

  function clickAt(x,y){
    if(!running){
      startGame(true);
	  BGM.play().catch(()=>{});
      return;
    }
    if(over) return;

    let hitIndex = -1;
    let best = Infinity;
    for(let i=0;i<bubbles.length;i++){
      const b = bubbles[i];
      if(dist2(x,y,b.x,b.y) <= b.r*b.r){
        const s = b.age;
        if(s < best){ best=s; hitIndex=i; }
      }
    }
    if(hitIndex>=0) popBubble(hitIndex);
    else{
      combo = 0; comboTimer = 0;
      // ===== miss æ‡²ç½°ï¼ˆå·²èª¿ä½ï¼‰=====
      pol = clamp(pol + 0.005, 0, 100);
      beep(130, 0.04, "sawtooth", 0.03);
      syncUI();
    }
  }

  canvas.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    const p = getCanvasPoint(e);
    clickAt(p.x,p.y);
  }, {passive:false});

  window.addEventListener("keydown", (e)=>{
    const k = e.key.toLowerCase();
    if(k === "r"){ e.preventDefault(); restart(); }
  });

  btnStart.addEventListener("click", ()=> startGame(true));
  btnRestart.addEventListener("click", ()=> restart());
  btnMute.addEventListener("click", ()=>{
    muted = !muted;
    btnMute.textContent = "éŸ³æ•ˆï¼š" + (muted ? "é—œ" : "é–‹");
    toastMsg(muted ? "éŸ³æ•ˆå·²é—œé–‰" : "éŸ³æ•ˆå·²é–‹å•Ÿ", muted ? "var(--muted)" : "var(--good)");
    if(!muted) beep(660, 0.04, "square", 0.05);
  });

  // ===== Scoring / Combo =====
  function addScore(base){
    const mult = banMode ? 2 : 1;
    score += Math.floor(base * mult);
  }

  function bumpCombo(){
    combo += 1;
    comboTimer = 3;
    if(combo >= 12 && !banMode){
      banMode = true;
      banModeTimer = 12.0;
      toastMsg("BAN MODE å•Ÿå‹•ï¼å¾—åˆ†åŠ å€ï¼", "var(--good)");
      beep(880, 0.08, "square", 0.08);
    }
  }

  function popBubble(i){
    const b = bubbles[i];
    bubbles.splice(i,1);

    spawnTextBurst(b.x, b.y, "BAN!", 10);
    beep(420 + rand(-60,60), 0.03, "square", 0.05);

    let basePoints = 1;

    if(b.type === TYPES.TRAVEL_PLATE){
      basePoints = -5;
      combo = 0; comboTimer = 0;
      pol = clamp(pol + 2.2, 0, 100);
      spawnTextBurst(b.x, b.y, "-5", 8);
      toastMsg("åœ‹æ—…ç›¤å­ï¼šæ‰£åˆ†ï¼", "var(--warn)");
      beep(160, 0.06, "sawtooth", 0.05);
    }else{
      bumpCombo();
    }

    if(b.type === TYPES.ANSWER_ME){
      pol = clamp(pol + 3.0, 0, 100);
      toastMsg("å›ç­”æˆ‘ï¼ä½ è¢«å¡ä½ä¸€ä¸‹â€¦", "var(--warn)");
      spawnTextBurst(b.x, b.y, "å›ç­”æˆ‘ï¼", 8);
      stunTimer = 0.5;
      beep(220, 0.08, "triangle", 0.05);
    }

    if(b.type === TYPES.NANO_BANANA){
      toastMsg("å¥ˆç±³é¦™è•‰ï¼šåˆ†è£‚æˆ 3 å€‹ï¼", "var(--warn)");
      for(let k=0;k<3;k++){
        const nb = makeBubble(
          clamp(b.x + rand(-18,18), 12, W-12),
          clamp(b.y + rand(-18,18), 12, H-12),
          TYPES.NORMAL,
          0.62
        );
        nb.vx *= 1.35; nb.vy *= 1.35;
        nb.life = rand(2.4, 3.6);
        bubbles.push(nb);
      }
      basePoints = 2;
      beep(520, 0.05, "square", 0.06);
    }

    if(b.type === TYPES.CASH_10K){
      toastMsg("æ™®ç™¼ä¸€è¬ï¼šæ¸…å ´ï¼çˆ½ï¼", "var(--good)");
      const cleared = bubbles.length;
      bubbles.length = 0;
      basePoints = 20 + cleared;
      spawnTextBurst(b.x, b.y, "å…¨å ´ BANï¼", 14);
      beep(990, 0.10, "square", 0.09);
    }

    addScore(basePoints);

    // ===== çˆ½å›è¡€ï¼ˆå·²èª¿åˆ°æ¯”è¼ƒå¥½ç©ï¼‰=====
    if(b.type === TYPES.NORMAL) pol = clamp(pol - 2.5, 0, 100);
    if(b.type === TYPES.NANO_BANANA) pol = clamp(pol - 1.5, 0, 100);
    if(b.type === TYPES.CASH_10K) pol = clamp(pol - 25, 0, 100);

    if(banMode && b.type !== TYPES.TRAVEL_PLATE && b.type !== TYPES.ANSWER_ME){
      pol = clamp(pol - 0.7, 0, 100);
    }

    syncUI();
  }

  function syncUI(){
    scoreEl.textContent = score;
    comboEl.textContent = combo;
    const pct = Math.floor(pol);
    polPctEl.textContent = pct + "%";
    polBarEl.style.width = pct + "%";
  }

  // ===== Update / Draw =====
  function update(dt){
    if(!running) return;

    timeAlive += dt;

    spawnRate = 1.2 + Math.min(4.0, timeAlive / 12);

    const maxBubbles = 10 + Math.floor(timeAlive/10);
    const target = clamp(maxBubbles, 10, 18); // ä¸Šé™å£“ä½

    spawnAcc += dt * spawnRate * (stunTimer>0 ? 0.25 : 1.0);
    while(spawnAcc >= 1){
      spawnAcc -= 1;
      if(bubbles.length < target){
        const burst = (Math.random() < 0.10) ? 2 : 1;
        for(let k=0;k<burst;k++){
          if(bubbles.length < target) bubbles.push(makeBubble());
        }
      }
    }

    if(comboTimer > 0){
      comboTimer -= dt;
      if(comboTimer <= 0) combo = 0;
    }

    if(banMode){
      banModeTimer -= dt;
      if(banModeTimer <= 0){
        banMode = false;
        toastMsg("BAN MODE çµæŸ", "var(--muted)");
      }
    }

    const slow = (stunTimer > 0) ? 0.22 : 1.0;
    if(stunTimer > 0) stunTimer -= dt;

    for(const b of bubbles){
      b.age += dt;
      b.x += b.vx * dt * slow;
      b.y += b.vy * dt * slow;

      if(b.x < b.r){ b.x=b.r; b.vx*=-1; }
      if(b.x > W-b.r){ b.x=W-b.r; b.vx*=-1; }
      if(b.y < b.r){ b.y=b.r; b.vy*=-1; }
      if(b.y > H-b.r){ b.y=H-b.r; b.vy*=-1; }

      b._pulse = (Math.sin((b.age*6)*b.wob)+1)*0.5;

      // ===== æ±¡æŸ“å€¼èª¿æ•´ï¼ˆå·²æ”¾æ…¢ï¼‰=====
      if(b.age > b.life){
        pol = clamp(pol + 0.09 * dt * 12, 0, 100);
      }else{
        pol = clamp(pol + 0.008 * dt * (1 + bubbles.length*0.02), 0, 100);
      }
    }

    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.age += dt;
      p.vy += p.g * dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      if(p.age >= p.life) particles.splice(i,1);
    }

    if(pol >= 100) gameOver();
    syncUI();
  }

  function drawBubbleFallbackText(b, rr){
    // æ²’åœ–æ™‚ç”¨æ–‡å­—ç‰ˆæœ¬
    ctx.save();
    ctx.translate(b.x, b.y);
    const rot = Math.sin(b.age*2) * 0.06;
    ctx.rotate(rot);
    ctx.globalAlpha = 0.95;

    let label = "XHS", lab2 = "BAN?";
    if(b.type === TYPES.NANO_BANANA){ label="NANO"; lab2="ğŸŒ"; }
    if(b.type === TYPES.TRAVEL_PLATE){ label="åœ‹æ—…"; lab2="ç›¤å­"; }
    if(b.type === TYPES.ANSWER_ME){ label="å›ç­”æˆ‘"; lab2="ï¼"; }
    if(b.type === TYPES.CASH_10K){ label="æ™®ç™¼"; lab2="10000"; }

    ctx.fillStyle = "rgba(0,0,0,0.25)";
    ctx.strokeStyle = "rgba(255,255,255,0.10)";
    ctx.lineWidth = 1;
    const w = rr*1.18, h = rr*0.74;
    roundRect(ctx, -w/2, -h/2, w, h, 10);
    ctx.fill(); ctx.stroke();

    ctx.fillStyle = "rgba(215,219,230,0.95)";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.font = "800 14px system-ui";
    ctx.fillText(label, 0, -5);
    ctx.font = "800 12px system-ui";
    ctx.fillText(lab2, 0, 12);

    ctx.restore();
  }

  function draw(){
    ctx.clearRect(0,0,W,H);

    // scanlines
    ctx.save();
    ctx.globalAlpha = 0.09;
    ctx.fillStyle = "#000";
    for(let y=0;y<H;y+=4) ctx.fillRect(0,y,W,1);
    ctx.restore();

    // red warning frame
    const warnA = clamp((pol-60)/40, 0, 1) * 0.35;
    if(warnA > 0){
      ctx.save();
      ctx.globalAlpha = warnA;
      ctx.strokeStyle = "#ff3b3b";
      ctx.lineWidth = 10;
      ctx.strokeRect(5,5,W-10,H-10);
      ctx.restore();
    }

    // bubbles
    for(const b of bubbles){
      const pulse = 1 + (b._pulse||0)*0.12;
      const rr = b.r * pulse;

      // bubble ring
      ctx.save();
      ctx.beginPath();
      ctx.arc(b.x, b.y, rr, 0, Math.PI*2);

      let fill = "rgba(255,59,59,0.12)";
      let stroke = "rgba(255,59,59,0.55)";
      if(b.type === TYPES.NANO_BANANA){ fill="rgba(255,204,51,0.14)"; stroke="rgba(255,204,51,0.62)"; }
      if(b.type === TYPES.TRAVEL_PLATE){ fill="rgba(154,163,178,0.14)"; stroke="rgba(154,163,178,0.62)"; }
      if(b.type === TYPES.ANSWER_ME){ fill="rgba(68,167,255,0.12)"; stroke="rgba(68,167,255,0.62)"; }
      if(b.type === TYPES.CASH_10K){ fill="rgba(124,255,107,0.13)"; stroke="rgba(124,255,107,0.70)"; }

      ctx.fillStyle = fill; ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = stroke; ctx.stroke();
      ctx.restore();

      // ===== draw image in the center (if available) =====
      const img = sprite[b.type];
      if(imgReady(img)){
        ctx.save();
        ctx.translate(b.x, b.y);
        const rot = Math.sin(b.age*2) * 0.06;
        ctx.rotate(rot);
        const s = (rr * 2) * 1.10; // åœ–ç‰‡å¤§å°ï¼ˆå¯æ”¹ 1.10ï¼‰
        ctx.drawImage(img, -s/2, -s/2, s, s);

        // BAN MODE glow
        if(banMode){
          ctx.globalAlpha = 0.18;
          ctx.strokeStyle = "rgba(124,255,107,0.9)";
          ctx.lineWidth = 5;
          ctx.beginPath();
          ctx.arc(0,0, rr*0.92, 0, Math.PI*2);
          ctx.stroke();
        }
        ctx.restore();
      }else{
        drawBubbleFallbackText(b, rr);
      }

      // lifetime ring
      const lifeP = clamp(b.age / b.life, 0, 1);
      ctx.save();
      ctx.beginPath();
      ctx.arc(b.x, b.y, rr+6, -Math.PI/2, -Math.PI/2 + Math.PI*2*lifeP);
      ctx.strokeStyle = (b.type===TYPES.CASH_10K) ? "rgba(124,255,107,0.55)" : "rgba(255,255,255,0.10)";
      ctx.lineWidth = 3;
      ctx.stroke();
      ctx.restore();
    }

    // particles
    for(const p of particles){
      const a = 1 - (p.age/p.life);
      ctx.save();
      ctx.globalAlpha = a;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.font = `900 ${p.size}px system-ui`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "rgba(255,59,59,0.95)";
      ctx.fillText(p.text, 0, 0);
      ctx.restore();
    }

    // overlay when not running
    if(!running){
      ctx.save();
      ctx.fillStyle = "rgba(0,0,0,0.50)";
      ctx.fillRect(0,0,W,H);

      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      ctx.font = "900 30px system-ui";
      const main = over ? "æ±¡æŸ“å€¼çˆ†è¡¨ï¼" : "é»ä¸€ä¸‹é–‹å§‹ BANï¼";
      ctx.fillText(main, W/2, H/2 - 20);

      ctx.font = "700 16px system-ui";
      const sub = over ? `ä½ çš„åˆ†æ•¸ï¼š${score}ï¼ˆæŒ‰ R é‡ä¾†ï¼‰` : "è¶Šä¹…è¶Šé›£ï¼Œé€£æ“Š 12 é€² BAN MODE";
      ctx.fillStyle = "rgba(215,219,230,0.85)";
      ctx.fillText(sub, W/2, H/2 + 18);

      ctx.restore();
    }

    // corner status
    ctx.save();
    ctx.globalAlpha = 0.9;
    ctx.fillStyle = "rgba(0,0,0,0.28)";
    roundRect(ctx, 10, 10, 190, 44, 12);
    ctx.fill();
    ctx.fillStyle = "rgba(215,219,230,0.9)";
    ctx.font = "800 13px system-ui";
    ctx.textAlign = "left";
    ctx.textBaseline = "alphabetic";
    ctx.fillText(`BAN MODE: ${banMode ? "ON" : "OFF"}`, 22, 30);
    ctx.fillStyle = "rgba(154,163,178,0.9)";
    ctx.font = "700 12px system-ui";
    ctx.fillText(`é€Ÿåº¦: ${spawnRate.toFixed(1)}/s`, 22, 44);
    ctx.restore();
  }

  function loop(tms){
    const t = tms/1000;
    const dt = Math.min(0.033, (t - lastT) || 0);
    lastT = t;

    update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  // init
  restart();
  running = false;
  btnStart.textContent = "é–‹å§‹";
  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
